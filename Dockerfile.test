# All-in-one Dockerfile for running app + Playwright tests
# This avoids network issues with Chromium SSL errors on non-localhost hostnames
# The app runs on localhost within the same container as the tests

FROM mcr.microsoft.com/playwright:v1.56.1-noble

WORKDIR /app

# Install dependencies for building Next.js
RUN apt-get update && apt-get install -y curl && rm -rf /var/lib/apt/lists/*

# Copy package files first for better caching
COPY package*.json ./

# Install all dependencies (including devDependencies for building)
RUN npm ci

# Copy application source
COPY . .

# Build the Next.js application
RUN npm run build

# Create a script that starts the app and runs tests
RUN echo '#!/bin/bash\n\
set -e\n\
echo "Starting Next.js server on localhost:3000..."\n\
npm start &\n\
SERVER_PID=$!\n\
\n\
# Wait for server to be ready\n\
echo "Waiting for server to be ready..."\n\
for i in {1..60}; do\n\
  if curl -sf http://localhost:3000/solacheck > /dev/null 2>&1; then\n\
    echo "Server is ready!"\n\
    break\n\
  fi\n\
  if [ $i -eq 60 ]; then\n\
    echo "Server failed to start in time"\n\
    exit 1\n\
  fi\n\
  sleep 1\n\
done\n\
\n\
# Run Playwright tests against localhost\n\
echo "Running Playwright tests..."\n\
PLAYWRIGHT_BASE_URL=http://localhost:3000 npx playwright test --reporter=list\n\
TEST_EXIT_CODE=$?\n\
\n\
# Cleanup\n\
kill $SERVER_PID 2>/dev/null || true\n\
\n\
exit $TEST_EXIT_CODE\n\
' > /app/run-tests.sh && chmod +x /app/run-tests.sh

CMD ["/bin/bash", "/app/run-tests.sh"]
